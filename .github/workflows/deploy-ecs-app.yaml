name: Deploy to ECS

on:
  push:
    branches:
      - main
jobs:
  publish-to-ecr:
    uses: shashimal/common-github-workflows/.github/workflows/deploy-ecr.yaml@main
    with:
      aws_region: "us-east-1"
      ecr_repository: "webapp"
      context: "./examples/ecr"
      file: "./examples/ecr/Dockerfile"
      tag_mutability: false
    secrets:
      iam_role_arn: ${{ secrets.AWS_GITHUB_IDENTITY_ROLE }}

  deploy-to-ecs:
    needs: [ publish-to-ecr ]
    uses: shashimal/common-github-workflows/.github/workflows/deploy-ecs.yaml@main
    with:
      aws_region: "us-east-1"
      cluster: 'test'
      service: "nginx-webapp-service"
      task_definition: "nginx-webapp"
      container_name: "nginx-webapp"
      image: ${{secrets.AWS_ACCOUNT}}.dkr.us-east-1.amazonaws.com/webapp:${{ needs.publish-to-ecr.outputs.image-tag }}
    secrets:
      iam_role_arn: ${{ secrets.AWS_GITHUB_IDENTITY_ROLE }}
